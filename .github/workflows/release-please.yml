name: release-please

on: 
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TMP_RELEASE_TOKEN }}
          fetch-depth: 0

      - id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.TMP_RELEASE_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          target-branch: main

      - name: Sync Lockfiles & Push
        if: ${{ steps.release.outputs.pr }}
        run: |
          # 1. Extract name of the release branch
          PR_BRANCH=$(echo '${{ steps.release.outputs.pr }}' | jq -r '.headBranchName')
          
          # 2. Configure Git
          git config user.name "MCU Release Bot"
          git config user.email "ebonding@fusiongbs.com"

          # 3. Fetch changes and pull origin
          git fetch origin $PR_BRANCH
          git checkout $PR_BRANCH
          git pull origin $PR_BRANCH

          # 4. Sync uv (mcu)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          cd mcu && uv lock && cd ..

          # 5. Sync npm (ui)
          cd ui && npm install --package-lock-only && cd ..

          # 6. Commit y Push with rebase
          git add **/uv.lock **/package-lock.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: update lockfiles for version bump"
            git pull --rebase origin $PR_BRANCH
            git push origin $PR_BRANCH
          else
            echo "No lockfile changes detected."
          fi