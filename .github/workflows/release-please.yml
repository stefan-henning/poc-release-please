name: release-please

on: 
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TMP_RELEASE_TOKEN }}
          fetch-depth: 0 # Importante para tener el histórico de ramas

      - id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.TMP_RELEASE_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          target-branch: main

      - name: Sync Lockfiles & Push
        if: ${{ steps.release.outputs.pr }}
        run: |
          # 1. Extraer nombre de la rama
          PR_BRANCH=$(echo '${{ steps.release.outputs.pr }}' | jq -r '.headBranchName')
          
          # 2. Configurar Git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 3. Traer cambios remotos y saltar a la rama
          git fetch origin $PR_BRANCH
          git checkout $PR_BRANCH
          git pull origin $PR_BRANCH  # Aseguramos que tenemos los últimos commits del bot

          # 4. Sincronizar uv (Python)
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          cd mcu && uv lock && cd ..

          # 5. Sincronizar npm (UI)
          cd ui && npm install --package-lock-only && cd ..

          # 6. Commit y Push con rebase preventivo
          git add **/uv.lock **/package-lock.json
          if ! git diff --cached --quiet; then
            git commit -m "chore: update lockfiles for version bump"
            # Usamos --rebase por si el bot hizo cambios mientras corríamos el lock
            git pull --rebase origin $PR_BRANCH
            git push origin $PR_BRANCH
          else
            echo "No lockfile changes detected."
          fi